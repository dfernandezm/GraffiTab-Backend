checkout:
  post:
    - git submodule sync
    - git submodule update --init

machine:
  node:
    version:
      5.6
  java:
    version:
      oraclejdk8

general:
  artifacts:
    - "graffitab.jar"
  branches:
    only:
      - master # list of branches to build
      - /feature.*/ # or regexes

dependencies:
  override:
    #- ./gradlew buildClient -Penv=openshiftDev
    - ./gradlew dependencies -Penv=digitalOceanDev

database:
  override:
    - ./gradlew updateDb -Penv=digitalOceanDev

test:
  override:
    - echo "Skipping test"

# Need to add one valid private SSH Key to CircleCI UI so it can authenticate against Openshift
deployment:
  staging:
    branch: feature/digitalocean
    commands:
      - echo "Generating JAR archive to deploy"
      - ./gradlew stage -Penv=digitalOceanDev
      - echo "==== Deploying to Digital Ocean - dev01 ===="
      - scp graffitab.jar $DO_USER@$DO_DEV01_DOMAIN:$DO_DEPLOYMENT_DIR
      - scp digitalOcean/start.sh $DO_USER@$DO_DEV01_DOMAIN:$DO_DEPLOYMENT_DIR
      - scp digitalOcean/stop.sh $DO_USER@$DO_DEV01_DOMAIN:$DO_DEPLOYMENT_DIR
      - echo "==== Stopping application - dev01 ===="
      - ssh $DO_USER@$DO_DEV01_DOMAIN 'source ~/environment.sh && chmod +x $DO_DEPLOYMENT_DIR/stop.sh' 2>&1
      - ssh $DO_USER@$DO_DEV01_DOMAIN 'source ~/environment.sh && bash $DO_DEPLOYMENT_DIR/stop.sh' 2>&1
      - ssh $DO_USER@$DO_DEV01_DOMAIN 'source ~/environment.sh && chmod +x $DO_DEPLOYMENT_DIR/start.sh' 2>&1
      - echo "==== Starting application in dev01 after deployment ===="
      - ssh $DO_USER@$DO_DEV01_DOMAIN 'source ~/environment.sh && cd $DO_DEPLOYMENT_DIR && nohup ./start.sh > start.log &' 2>&1
      - echo "==== Deploying to Digital Ocean - dev02 ===="
      - scp graffitab.jar $DO_USER@$DO_DEV02_DOMAIN:$DO_DEPLOYMENT_DIR
      - scp digitalOcean/start.sh $DO_USER@$DO_DEV02_DOMAIN:$DO_DEPLOYMENT_DIR
      - scp digitalOcean/stop.sh $DO_USER@$DO_DEV02_DOMAIN:$DO_DEPLOYMENT_DIR
      - echo "==== Stopping application - dev02 ===="
      - ssh $DO_USER@$DO_DEV02_DOMAIN 'source ~/environment.sh && bash $DO_DEPLOYMENT_DIR/stop.sh' 2>&1
      - ssh $DO_USER@$DO_DEV02_DOMAIN 'source ~/environment.sh && chmod +x $DO_DEPLOYMENT_DIR/start.sh' 2>&1
      - echo "==== Starting application in dev02 after deployment ===="
      - ssh $DO_USER@$DO_DEV02_DOMAIN 'source ~/environment.sh && cd $DO_DEPLOYMENT_DIR && nohup ./start.sh > start.log &' 2>&1


